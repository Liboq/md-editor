# 实现计划：Markdown 编辑器

## 概述

实现一个 Markdown 编辑器，包含双栏布局、实时预览、6 种内置主题、自定义主题支持和微信公众号复制功能。使用 Next.js 14 (App Router) + shadcn/ui + Tailwind CSS 构建。

## 任务

- [x] 1. 初始化 Next.js 项目和基础配置
  - 创建 Next.js 14 项目 (App Router)
  - 初始化 shadcn/ui (`npx shadcn@latest init`)
  - 配置 Tailwind CSS 和 Inter 字体
  - 安装必要依赖：marked、fast-check、vitest
  - _需求: 1.1, 1.2, 8.1_

- [x] 2. 创建基础布局和 UI 组件
  - [x] 2.1 安装 shadcn/ui 组件
    - 安装 Button、Textarea、Select、Tabs、Dialog、Toaster 组件
    - `npx shadcn@latest add button textarea select tabs dialog sonner`
    - _需求: 7.1_
  
  - [x] 2.2 创建双栏响应式布局
    - 在 `app/page.tsx` 创建主页面
    - 实现 50/50 分栏布局（桌面端）
    - 实现垂直堆叠布局（移动端 <768px）
    - _需求: 1.1, 1.3, 1.4, 1.5, 8.1, 8.2, 8.3_

- [x] 3. 实现编辑器模块
  - [x] 3.1 创建 Editor 组件
    - 在 `app/_components/editor/Editor.tsx` 创建编辑器
    - 使用 shadcn Textarea 组件
    - 添加等宽字体样式
    - _需求: 7.4_
  
  - [x] 3.2 实现编辑器工具栏
    - 在 `app/_components/editor/Toolbar.tsx` 创建工具栏
    - 添加格式化按钮（粗体、斜体、标题、链接、图片、代码、列表、引用、表格）
    - 使用 Lucide React 图标
    - _需求: 7.1_
  
  - [x] 3.3 实现文本格式化功能
    - 创建 `useEditor` hook
    - 实现 `wrapSelection(prefix, suffix)` 函数
    - 实现 `insertAtCursor(text)` 函数
    - 连接工具栏按钮到格式化函数
    - _需求: 7.2_
  
  - [ ]* 3.4 编写文本格式化属性测试
    - **属性 8: 文本格式化正确包裹选中内容**
    - **验证: 需求 7.2**
  
  - [x] 3.5 实现键盘快捷键
    - Ctrl/Cmd+B 粗体，Ctrl/Cmd+I 斜体
    - Ctrl/Cmd+K 链接，Ctrl/Cmd+Shift+C 代码
    - Tab 缩进代码块和列表
    - _需求: 7.3, 7.5_

- [x] 4. 实现 Markdown 解析和预览模块
  - [x] 4.1 集成 Markdown 解析库
    - 安装 marked.js
    - 在 `lib/markdown/parser.ts` 封装解析器
    - 配置 GFM (GitHub Flavored Markdown) 选项
    - _需求: 2.2_
  
  - [x] 4.2 实现 Preview 组件
    - 在 `app/_components/preview/Preview.tsx` 创建预览组件
    - 实现 `render(html)` 函数
    - 添加内容包装器用于主题样式
    - _需求: 2.3_
  
  - [x] 4.3 连接编辑器和预览（防抖更新）
    - 添加 input 事件监听器
    - 实现 100ms 防抖以提升性能
    - 内容变化时解析 Markdown 并更新预览
    - _需求: 2.1, 2.3_
  
  - [ ]* 4.4 编写 Markdown 解析属性测试
    - **属性 1: Markdown 解析产生有效的 HTML 结构**
    - **验证: 需求 2.2, 2.3**
  
  - [x] 4.5 实现滚动同步（可选功能）
    - 计算编辑器滚动百分比
    - 按比例同步预览滚动位置
    - 添加滚动同步偏好开关
    - _需求: 2.5_

- [x] 5. 检查点 - 验证编辑器和预览功能
  - 确保所有测试通过，如有问题询问用户。

- [x] 6. 实现主题系统
  - [x] 6.1 创建主题数据结构和内置主题
    - 在 `lib/themes/types.ts` 定义 Theme 接口
    - 在 `lib/themes/built-in.ts` 创建 6 个内置主题对象
    - 默认白色、OLED 暗黑、墨绿、橙色暖色、紫色优雅、蓝色科技
    - _需求: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_
  
  - [x] 6.2 实现 ThemeContext
    - 在 `lib/themes/theme-context.tsx` 创建 ThemeProvider
    - 实现 `useTheme` hook
    - 实现 `setActiveTheme(id)` 函数
    - _需求: 3.1, 3.2_
  
  - [ ]* 6.3 编写主题注册属性测试
    - **属性 6: 主题注册和检索**
    - **验证: 需求 3.1**
  
  - [x] 6.4 实现主题应用到预览
    - 创建 CSS 变量注入机制
    - 将主题样式应用到预览内容元素
    - 主题切换时立即更新预览
    - _需求: 3.2_
  
  - [ ]* 6.5 编写主题应用属性测试
    - **属性 7: 主题应用反映样式**
    - **验证: 需求 3.2**
  
  - [x] 6.6 实现主题持久化
    - 保存激活主题 ID 到 localStorage
    - 应用启动时加载并恢复主题
    - 优雅处理缺失/无效的存储主题
    - _需求: 3.3, 3.4_
  
  - [ ]* 6.7 编写主题持久化属性测试
    - **属性 2: 主题持久化往返**
    - **验证: 需求 3.3, 3.4**

- [x] 7. 实现主题选择器 UI
  - [x] 7.1 创建主题选择器组件
    - 使用 shadcn Select 或 DropdownMenu 组件
    - 显示每个主题的名称和颜色预览
    - 高亮当前激活的主题
    - _需求: 4.7_
  
  - [x] 7.2 连接主题选择器到 ThemeContext
    - 处理主题选择点击事件
    - 更新预览并持久化选择
    - _需求: 3.2_

- [x] 8. 检查点 - 验证主题系统功能
  - 确保所有测试通过，如有问题询问用户。

- [x] 9. 实现自定义主题支持
  - [x] 9.1 创建主题编辑器 UI
    - 使用 shadcn Dialog 创建主题编辑弹窗
    - 使用 react-hook-form + Zod 构建表单
    - 添加颜色选择器（背景、文字、强调色）
    - _需求: 5.1, 5.3_
  
  - [x] 9.2 实现主题验证
    - 验证必需字段（id、name、styles）
    - 验证颜色格式（hex）
    - 返回无效配置的验证错误
    - _需求: 5.2_
  
  - [ ]* 9.3 编写主题验证属性测试
    - **属性 10: 主题验证接受有效配置并拒绝无效配置**
    - **验证: 需求 5.2**
  
  - [x] 9.4 实现自定义主题保存/删除
    - 保存自定义主题到 localStorage
    - 添加自定义主题删除功能
    - 阻止删除内置主题
    - _需求: 5.4_
  
  - [ ]* 9.5 编写自定义主题存储属性测试
    - **属性 3: 自定义主题存储往返**
    - **验证: 需求 3.5, 5.4**
  
  - [x] 9.6 实现主题导出/导入
    - 导出主题为可下载的 JSON 文件
    - 从 JSON 文件上传导入主题
    - 添加前验证导入的主题
    - _需求: 5.5, 5.6_
  
  - [ ]* 9.7 编写主题导出/导入属性测试
    - **属性 4: 主题导出/导入往返**
    - **验证: 需求 5.5, 5.6**

- [x] 10. 实现复制到微信公众号功能
  - [x] 10.1 创建行内样式转换器
    - 在 `lib/clipboard/inline-converter.ts` 创建转换器
    - 构建遍历 DOM 并收集计算样式的函数
    - 将 CSS 类转换为行内 style 属性
    - 处理所有元素类型（标题、段落、代码、列表、表格等）
    - _需求: 6.1, 6.4_
  
  - [ ]* 10.2 编写行内样式转换属性测试
    - **属性 5: 行内样式转换完整性**
    - **验证: 需求 6.1, 6.4**
  
  - [x] 10.3 实现剪贴板管理
    - 在 `lib/clipboard/copy.ts` 创建 `copyHTML(html)` 函数
    - 使用 Clipboard API
    - 处理剪贴板权限和错误
    - _需求: 6.2_
  
  - [x] 10.4 创建复制按钮和通知
    - 在工具栏添加"复制到公众号"按钮
    - 使用 shadcn Sonner 显示成功通知
    - 失败时显示错误消息和后备说明
    - _需求: 6.5, 6.6_

- [x] 11. 检查点 - 验证复制功能
  - 确保所有测试通过，如有问题询问用户。

- [x] 12. 完善响应式设计
  - [x] 12.1 实现响应式断点
    - 桌面端 (≥1024px): 完整双栏布局带工具栏
    - 平板端 (768-1023px): 紧凑双栏布局
    - 移动端 (<768px): 堆叠布局带标签切换
    - _需求: 8.1, 8.2, 8.3, 8.4_
  
  - [x] 12.2 添加移动端标签切换 UI
    - 使用 shadcn Tabs 组件
    - 创建编辑器/预览切换标签按钮
    - 实现视图间平滑过渡
    - _需求: 8.3_
  
  - [x] 12.3 最终样式和完善
    - 确保一致的间距和排版
    - 添加 hover 状态和 cursor-pointer
    - 验证明暗模式对比度
    - 在 320px 最小宽度测试
    - _需求: 8.4_

- [x] 13. 最终检查点
  - 确保所有测试通过，如有问题询问用户。
  - 验证所有 6 个主题正确渲染
  - 测试复制到剪贴板功能
  - 验证所有断点的响应式布局

## 备注

- 标记 `*` 的任务为可选，可跳过以加快 MVP 开发
- 每个任务引用特定需求以便追溯
- 检查点确保增量验证
- 属性测试使用 fast-check 库，最少 100 次迭代
- 单元测试验证特定示例和边界情况
- 使用 shadcn/ui 组件时遵循 react-hook-form + Zod 模式
